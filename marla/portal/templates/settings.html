{% extends "base.html" %}

{% block content %}
{% load static %}

<!-- Include Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">

<style>
    body, html {
        height: 100%;
        margin: 0;
        font-family: 'Roboto', sans-serif;
    }

    .title {
        font-size: 3rem;
    }

    .subtitle {
        font-size: 2.5rem;
    }

    .text {
        font-size: 2rem;
    }

    .background {
        background: linear-gradient(-45deg, rgb(248, 224, 240), white 30% 70%, rgb(217, 242, 248));
        height: 100%;
        display: flex;
    }

    .flat-button {
        background-color: transparent;
        border: 1px solid gray;
        color: gray;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        transition-duration: 0.1s;
        cursor: pointer;
        margin-top: 8px;
    }

    .flat-button:hover {
        background-color: rgba(0, 0, 0, 0.1); /* a very light gray on hover */
        color: black;
    }

    .sidebar {
        height: 100%;
        
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: start;
    }

    .sidebar a {
        margin: 10px;
        text-decoration: none;
        color: #333;
    }

    .sidebar a:hover {
        color: #007bff;
    }

    .content-area {
        padding: 32px;
        display: flex;
        flex-direction: column;
        justify-content: start;
        height: 100%;
        width: 100%;
    }

    .padded-section {
        margin-top: 32px;
        width: 100%
    }

    .dot-pulse {
        position: relative;
        left: -9999px;
        width: 10px;
        height: 10px;
        border-radius: 5px;
        background-color: gray;
        color: gray;
        box-shadow: 9999px 0 0 -5px;
        animation: dot-pulse 1.5s infinite linear;
        animation-delay: 0.25s;
        opacity: 0.5;
        }
        .dot-pulse::before, .dot-pulse::after {
        content: "";
        display: inline-block;
        position: absolute;
        top: 0;
        width: 10px;
        height: 10px;
        border-radius: 5px;
        background-color: gray;
        color: gray;
        opacity: 0.5;
        }
        .dot-pulse::before {
        box-shadow: 9984px 0 0 -5px;
        animation: dot-pulse-before 1.5s infinite linear;
        animation-delay: 0s;
        }
        .dot-pulse::after {
        box-shadow: 10014px 0 0 -5px;
        animation: dot-pulse-after 1.5s infinite linear;
        animation-delay: 0.5s;
        }

        @keyframes dot-pulse-before {
        0% {
            box-shadow: 9984px 0 0 -5px;
        }
        30% {
            box-shadow: 9984px 0 0 2px;
        }
        60%, 100% {
            box-shadow: 9984px 0 0 -5px;
        }
        }
        @keyframes dot-pulse {
        0% {
            box-shadow: 9999px 0 0 -5px;
        }
        30% {
            box-shadow: 9999px 0 0 2px;
        }
        60%, 100% {
            box-shadow: 9999px 0 0 -5px;
        }
        }
        @keyframes dot-pulse-after {
        0% {
            box-shadow: 10014px 0 0 -5px;
        }
        30% {
            box-shadow: 10014px 0 0 2px;
        }
        60%, 100% {
            box-shadow: 10014px 0 0 -5px;
        }
    }
</style>

<script>
    async function updateContext() {
        const contextInput = document.getElementById('contextInput');
        const businessNameInput = document.getElementById('businessName');
        const chatbotNameInput = document.getElementById('chatbotName');
        const toneInput = document.getElementById('tone');

        const apiKey = "{{ user.api_key }}";
        const updatedContext = contextInput.value;
        const updatedBusinessName = businessNameInput.value;
        const updatedChatbotName = chatbotNameInput.value;

        const response = await fetch("{% url 'update-context' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `api_key=${encodeURIComponent(apiKey)}&context=${encodeURIComponent(updatedContext)}&business_name=${encodeURIComponent(updatedBusinessName)}&chatbot_name=${encodeURIComponent(updatedChatbotName)}&tone=${encodeURIComponent(toneInput.value)}`
        });

        if (response.ok) {
            alert('Context updated successfully');
        } else {
            const errorData = await response.json();
            alert('Error updating context: ' + errorData.error);
        }
    }

    async function testAPI() {
            const questionInput = document.getElementById('questionInput');
            const responseDisplay = document.getElementById('responseDisplay');
            const apiKey = "{{ user.api_key }}";
            const question = questionInput.value;

            // If no question was entered, don't do anything.
            if (!question) {
                questionInput.value = "Please enter a question."
                return;
            }


            // Update the response to indicate progress.
            responseDisplay.innerHTML = '<span class="dot-pulse" style="margin-left: 16px;"></span>';

            const response = await fetch("{% url 'ask' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    api_key: apiKey,
                    question: question
                })
            });

            if (response.ok) {
                const responseData = await response.json();
                responseDisplay.innerText = responseData.answer;
            } else {
                const errorData = await response.json();
                alert('Error asking question: ' + errorData.error);
            }
        }

    function setupEventListeners() {
        const updateButton = document.querySelector('.content-area .form-group .btn');
        updateButton.addEventListener('click', updateContext);

        const testAPIButton = document.getElementById('testAPIButton');
        testAPIButton.addEventListener('click', testAPI);
    }

    document.addEventListener('DOMContentLoaded', setupEventListeners);
</script>

<div class="background">
    <div class="sidebar">
        <a href="{% url 'account' %}">
            <img src="https://img.icons8.com/cotton/64/null/gender-neutral-user--v3.png"/ alt="Account Settings" title="Account Settings"  style="opacity: 0.5">
        </a>
        <a href="{% url 'settings' %}">
            <img src="https://img.icons8.com/cotton/64/null/chat.png" alt="Chat Settings" title="Chat Settings">
        </a>
        <a href="{% url 'integrations' %}">
            <img src="https://img.icons8.com/cotton/64/null/puzzle.png" alt="Integrations" title="Integrations" style="opacity: 0.5">
        </a>
    </div>
    <div class="content-area" style="overflow-y: scroll;">
        <h2 class="title">Hey there, {{ user.email }}</h2>
        
        <div class="form-group padded-section">
            <h2 class="subtitle" style="color: rgb(63, 112, 185)"><b>Step 1. Configure your Chatbot</b></h2>
            <hr style="border-color: #333;"/>

            <div style="display: flex; justify-content: start;">
                <div style="width: 25%; margin-right: 20px;">
                    <label for="businessName">Business Name:</label>
                    <p>The chatbot will refer to your business by this name.</p>
                    <input class="form-control" id="businessName" value="{{ context.business_name }}" style="width: 100%"></input>
                    <br>
                </div>
                
                <div style="width: 25%; margin-right: 20px;">
                    <label for="chatbotName">Chatbot Name:</label>
                    <p>Your chatbot will refer to itself by this name. </p>
                    <input class="form-control" id="chatbotName" value="{{ context.chatbot_name }}" style="width: 100%"></input>
                    <br>
                </div>

                <div style="width: 25%; margin-right: 20px;">
                    <label for="tone">Chatbot Tone:</label>
                    <p>Select the tone of voice for your chatbot.</p>
                    <select class="form-control" id="tone" style="width: 100%">
                        <option value="polite" {% if context.tone_of_voice == "polite" %}selected{% endif %}>Polite & Courteous</option>
                        <option value="relaxed" {% if context.tone_of_voice == "relaxed" %}selected{% endif %}>Relaxed & Conversational</option>
                        <option value="pirate" {% if context.tone_of_voice == "pirate" %}selected{% endif %}>Pirate</option>
                    </select>
                    <br>
                </div>
            </div>

            
            
            <label for="contextInput">Chatbot Context:</label>
            <p>The chatbot context is the knowledge your chatbot has about your specific business. It will not talk about anything outside of what is in the context. Add information in here such as opening times, types of products, services you offer, etc.</p>
            <textarea class="form-control" id="contextInput" rows="12" style="width: 50%">{{ context.content }}</textarea>
            <button class="btn flat-button mt-2">Update Context</button>
        </div>
        <div class="form-group mt-4 padded-section">
            <h2 class="subtitle" style="color: rgb(63, 112, 185)"><b>Step 2. Test</b></h2>
            <hr style="border-color: #333;"/>
            <label for="questionInput">Enter a question here to send it to your chatbot:</label>
            <input type="text" class="form-control" id="questionInput" placeholder="Enter a question" style="margin-top: 5px; width: 50%">
            <button id="testAPIButton" class="btn flat-button mt-2">Submit</button>
            <p id="responseDisplay" class="mt-2 text" style="margin-top: 16px;">Answer will appear here.</p>
        </div>
    </div>
</div>

<!-- Include Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script>
</script>
{% endblock %}

